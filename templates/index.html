{% extends "layout.html" %}

{% block content %}
<div class="row" x-data="statusCheck" x-init="checkAll()">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Firefly III</span>
                <span class="badge"
                      :class="firefly.status === 'ok' ? 'bg-success' : (firefly.status === 'fail' ? 'bg-danger' : 'bg-warning')"
                      x-text="firefly.status === 'ok' ? 'Connected' : (firefly.status === 'fail' ? 'Disconnected' : 'Checking...')">
                </span>
            </div>
            <div class="card-body">
                <template x-if="firefly.status === null">
                    <p class="text-muted">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Checking status...
                    </p>
                </template>
                <template x-if="firefly.status === 'ok'">
                    <p class="text-success">Firefly III is properly configured and reachable.</p>
                </template>
                <template x-if="firefly.status === 'fail'">
                    <p class="text-danger">
                        Connection failed. Please check configuration.
                        <a href="/configuration" class="btn btn-primary ms-2">Fix Configuration</a>
                    </p>
                </template>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>TrueLayer</span>
                <span class="badge"
                      :class="truelayer.status === 'ok' ? 'bg-success' : (truelayer.status === 'fail' ? 'bg-danger' : 'bg-warning')"
                      x-text="truelayer.status === 'ok' ? 'Connected' : (truelayer.status === 'fail' ? 'Disconnected' : 'Checking...')">
                </span>
            </div>
            <div class="card-body">
                <template x-if="truelayer.status === null">
                    <p class="text-muted">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Checking status...
                    </p>
                </template>
                <template x-if="truelayer.status === 'ok'">
                    <p class="text-success">TrueLayer is properly configured and reachable.</p>
                </template>
                <template x-if="truelayer.status === 'fail'">
                    <p class="text-danger">
                        Connection failed. Please check configuration.
                        <a href="/configuration" class="btn btn-primary ms-2">Fix Configuration</a>
                    </p>
                </template>
            </div>
        </div>
    </div>

    <div class="col-md-12">
        <template x-if="firefly.status === 'ok' && truelayer.status === 'ok'">
            <div class="card mb-4">
                <div class="card-header">Import</div>
                <div class="card-body">
                    <p>To import transactions from TrueLayer to Firefly III, click the button below.</p>
                    <a href="/import" class="btn btn-primary">Import Transactions</a>
                </div>
            </div>
        </template>

        <template x-if="firefly.status !== 'ok' || truelayer.status !== 'ok'">
            <div class="alert alert-warning" role="alert">
                One or more services are not properly configured. Please check the configuration.
            </div>
        </template>
    </div>
</div>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('statusCheck', () => ({
            firefly: { status: null },
            truelayer: { status: null },

            async checkAll() {
                await Promise.all([this.checkFirefly(), this.checkTrueLayer()]);
            },

            async checkFirefly() {
                try {
                    const res = await fetch('/firefly/healthcheck');
                    const data = await res.json();
                    this.firefly.status = (res.ok && data.status === 'OK') ? 'ok' : 'fail';
                    console.log("Firefly III status:", this.firefly.status);	
                } catch (err) {
                    this.firefly.status = 'fail';
                    console.error('Error checking Firefly III status:', err);
                }
            },

            async checkTrueLayer() {
                try {
                    const res = await fetch('/truelayer/healthcheck');
                    const data = await res.json();
                    this.truelayer.status = (res.ok && data.status === 'OK') ? 'ok' : 'fail';
                    console.log("TrueLayer status:", this.truelayer.status);
                } catch (err) {
                    this.truelayer.status = 'fail';
                    console.error('Error checking TrueLayer status:', err);
                }
            }
        }));
    });
</script>

{% endblock %}
